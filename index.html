<html>
<head>
    <meta charset="UTF-8">
    <title>Finger Shapekeys</title>
    <script src="babylon.js"></script>
    <script src="babylon.glTF2FileLoader.js"></script>
    <script src="QueuedInterpolation.1.1.min.js"></script>
    <script src="hand.js"></script>
    
    <script src="TOB_body.js"></script>
    <script src="TOB_cloth1.js"></script>
    
    <script src="models/md.js"></script>
    <script src="models/mdcloth/TOB_mdcloth.js"></script>
    <script src="ts.js"></script>
    <script src="TS_bodylab.js"></script>
    <script src="TOB_BJSHQ.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css">
    <style>
         html, body   { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
         #renderCanvas{ width: 100%; height: 100%; }
         input.number {width:80px;text-align: right;}
        .btn {
            background-color: white;
            color: black;
            border-radius: 100px;
            border: 3px solid #4CAF50; /* Green */
            height: 40px;
            width: 100px;
            font-size: 20px;
        }
         #buttonbar {
             width:140px;
             height: 760px;
             padding:10px;
             visibility: hidden;          
             position: absolute;
             top: 50%;
             left: 45%;
             margin: -400px 0 0 225px;
            
             border-left-width: 3px ;
             border-left-style: solid;
             border-left-color:#FFAC55;
             padding:20px;
             background-color: white;
            
        }
         #renderCanvas {
             visibility: hidden;
             border-width:medium;
             height: 800px;
             width: 450px;
             position: absolute;
             top: 50%;
             left: 45%;
             margin: -400px 0 0 -225px;
             background-color: white;
             
        }   
        #tryon {
            transition-duration: 0.4s;
            background-color: white;
            color: black;
            border-radius: 10px;
            border: 2px solid #4CAF50; /* Green */
            height: 100px;
            width: 140px;
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 20px;
            margin: -50px 0 0 -70px;
            transition-duration: 0.1s;
        }
        #tryon:hover {
            background-color: #4CAF50; /* Green */
            color: white;
        }
         #close {
            transition-duration: 0.4s;
            background-color: white;
            color: black;
            border-radius: 4px;
            border: 2px solid #4CAF50; /* Green */
            height: 40px;
            width: 100px;
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 20px;
            margin: 340px 0 0 -50px;
            transition-duration: 0.1s;
        }
        #close:hover {
            background-color: #4CAF50; /* Green */
            color: white;
        }
        #change {
            transition-duration: 0.4s;
            background-color: white;
            color: black;
            border-radius: 4px;
            border: 2px solid #4CAF50; /* Green */
            height: 50px;
            width: 50px;
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 20px;
            margin: 160px 0 0 -60px;
            transition-duration: 0.1s;
        }
        
        #change:hover {
            background-color: #4CAF50; /* Green */
            color: white;
        }
         #change1 {
            transition-duration: 0.4s;
            background-color: white;
            color: black;
            border-radius: 4px;
            border: 2px solid #4CAF50; /* Green */
            height: 50px;
            width: 50px;
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 20px;
            margin: 160px 0 0 10px;
            transition-duration: 0.1s;
        }
        
        #change1:hover {
            background-color: #4CAF50; /* Green */
            color: white;
        }
        #topbar {
            background-color: grey; /* Green */
            height: 100px;
        }
        
    </style>
</head>
   
    
<body>
              
    <label id="fpsLabel" style="padding:5px;background-color: white;">test</label>
 
    <div id="topbar" > 
    
    </div>
    <div >
    <button id="tryon" onclick="popup()">Try-on</button>
    </div>
  
    <canvas id="renderCanvas">
    </canvas>
    
<div id="buttonbar">
<font face="微軟正黑體">     
<label id="label1">Height</label>
<input id="slide1" type="range" min="0" max="1" step="0.25"  value="0"
       onchange="updateslidervertexdeformation(this.value,slide2.value,slide3.value,slide4.value,slide5.value,slide6.value,slide7.value),clothsizeupdate()" >
<label id="label2">Weight</label>
<input id="slide2" type="range" min="0" max="0.8" step="0.2"  value="0"
       onchange="updateslidervertexdeformation(slide1.value,this.value,slide3.value,slide4.value,slide5.value,slide6.value,slide7.value),clothsizeupdate()" >
<label id="label3">Waist</label>
<input id="slide3" type="range" min="0" max="1" step="0.1" value="0" 
       onchange="updateslidervertexdeformation(slide1.value,slide2.value,this.value,slide4.value,slide5.value,slide6.value,slide7.value),clothsizeupdate()">    
<label id="label4">UpperChest</label>
<input id="slide4" type="range" min="0" max="1" step="0.1" value="0" 
        onchange="updateslidervertexdeformation(slide1.value,slide2.value,slide3.value,this.value,slide5.value,slide6.value,slide7.value),clothsizeupdate()">
<label id="label5">Shoudler</label>
<input id="slide5" type="range" min="0" max="1" step="0.1" value="0" 
        onchange="updateslidervertexdeformation(slide1.value,slide2.value,slide3.value,slide4.value,this.value,slide6.value,slide7.value),clothsizeupdate()">
<label id="label6">Hips</label>
<input id="slide6" type="range" min="0" max="1" step="0.1" value="0" 
        onchange="updateslidervertexdeformation(slide1.value,slide2.value,slide3.value,slide4.value,slide5.value,this.value,slide7.value),clothsizeupdate()">
<label id="label7">Breast</label>
<input id="slide7" type="range" min="0" max="1" step="0.1" value="0" 
        onchange="updateslidervertexdeformation(slide1.value,slide2.value,slide3.value,slide4.value,slide5.value,slide6.value,this.value),clothsizeupdate()">

    
    
    
<button id="change" onclick="change()">1</button>    
<button id="change1" onclick="change1()">2</button>    
<button id="close" onclick="exit()">Close</button>
</font>              
</div>
    
<script>
    function popup() {
        document.getElementById("renderCanvas").style.visibility = "visible";
        document.getElementById("buttonbar").style.visibility = "visible";
    }
    function exit() {
        document.getElementById("renderCanvas").style.visibility = "hidden";
        document.getElementById("buttonbar").style.visibility = "hidden";
    }
    function change1() {
       
       
    }
    function change() {
      
      
                   
        
       
    }
    </script>
    
<script>
    var scene;
    var human;

//    var left = document.getElementById("left");
//    left.selectedIndex = 0;

    var right = document.getElementById("right");


    //right.selectedIndex = 0;

    if (BABYLON.Engine.isSupported()) {
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        
        engine.setHardwareScalingLevel(0.8) //increase the rendering quality. default = 1 (0.5~4)
        console.log(engine);
        console.log(engine.getHardwareScalingLevel());

        scene = new BABYLON.Scene(engine);

        
        
        /*
        var camera = scene.getCameraByID("Camera");
        camera.wheelPrecision = 10;
        var light = new BABYLON.PointLight("spot", BABYLON.Vector3.Zero(), scene);
        light.intensity = 1.0;
        */
        
        scene.autoClear = false; // keep bg white

        // Creates, angles, distances and targets the camera
	    var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 10, new BABYLON.Vector3(0 , 105, 0), scene);
        
        // This positions the camera
        scene.activeCamera = camera;
        camera.setPosition(new BABYLON.Vector3(0 , 105, -300.0));
        // This attaches the camera to the canvas
        camera.attachControl(canvas, true);
        
	   /**************************************************************/

        // This creates a light, aiming 0,1,0 - to the sky (non-mesh)
        //var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
	    //Create a light
        var light1 = new BABYLON.HemisphericLight("Omni1", new BABYLON.Vector3(-1.8, 0, -2.0), scene);
        var light2 = new BABYLON.HemisphericLight("Omni2", new BABYLON.Vector3( 1.8, -1.5, -2.0), scene);
        var light3 = new BABYLON.HemisphericLight("Omni3", new BABYLON.Vector3(-1.8, -1.5, 2.0), scene);
        var light4 = new BABYLON.HemisphericLight("Omni4", new BABYLON.Vector3( 1.8, -1.5, 2.0), scene);

        scene.beforeCameraRender = function () {
            light1.intensity = 0.6;
            light2.intensity = 0.5;   
            light3.intensity = 0.8;
            light4.intensity = 0.5;    
            
            
        };

        /************************* Load Human *************************************/
        var anim = new BABYLON.Animation("fade", "visibility", 60,  BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
	    var keys = [];
       
         keys.push({
	              frame: 0,
	              value: 2.0
            });
	        keys.push({
	              frame: 60,
	              value: 0.0
            });
	        anim.setKeys(keys);
        
        
        
        var cloth = new md.MeshFactory(scene); // materialsRootDir optional
        var mdbody = cloth.instance("bodyShape_skin_Shape"); // cloneSkeleton optional
        var floor = cloth.instance("Plane"); // cloneSkeleton optional
        
        
        
	    
        mdbody.animations.push(anim);
	    scene.beginAnimation(mdbody, 60, 0, true, 1);
        /************************* Load Cloth *************************************/
        
        var record_last_mesh_num = scene.meshes.length;

        
        
        var bumpMaterial = new BABYLON.PBRMaterial("blue silk.jpg", scene);
        bumpMaterial.albedoTexture  = new BABYLON.Texture("blue silk.jpg", scene);
        bumpMaterial.bumpTexture = new BABYLON.Texture("normalMap.jpg", scene);
        //bumpMaterial.baseColor = new BABYLON.Color3(1.000, 0.766, 0.336);
        bumpMaterial.metallic = 0.2;
        bumpMaterial.roughness = 0.3;
        //---------------------------------
        // cloth animation initial setting
        //---------------------------------
        var cloth_ani_step = 0.025;
        var cloth_shapekey_val = cloth_ani_step;
        var direction = 1;
        var delay_cnt = 0;
        
        
        
        clothsizeupdate();
        
     
        
      
   
        //console.log(scene.meshes);

        scene.executeWhenReady(function() {
            engine.runRenderLoop(function () { 
                scene.render();                 
                var fpsLabel = document.getElementById("fpsLabel");
                fpsLabel.innerHTML = engine.getFps().toFixed() + " fps";
                
                //////////////////////////
                // animate cloth -- begin
                //////////////////////////
                var cloth_shapekey_quene;

                var duration = 1 ;  //parseInt(document.getElementById("duration").value);
                var delay_cnt_max = 2;
                
                var cloth_step_real=cloth_ani_step;
                
                
                if ((cloth_shapekey_val>=1) || (cloth_shapekey_val<=0))
                {
                    //console.log( "DELAT_CNT = " + delay_cnt);
                    
                    if(delay_cnt==0){
                        //console.log("delay cnt ==0");
                        direction = direction *(-1);
                        delay_cnt = delay_cnt_max;
                        cloth_step_real = 0;
                    }
                    else if(delay_cnt==1){
                            //console.log("delay cnt =1");
                            cloth_step_real = cloth_ani_step;
                            delay_cnt -=1 ; // timer counting to 0
                        }
                    else {                // delaying 
                            //console.log("delay cnt =1~19");
                            delay_cnt -=1 ; // timer counting
                    }
                    
                }
                               
                cloth_shapekey_val = cloth_shapekey_val + (cloth_step_real * direction);
                
                //clamp funciton
                if(cloth_shapekey_val >1)       cloth_shapekey_val=1.0;
                else if(cloth_shapekey_val <0)  cloth_shapekey_val=0.0;
                
                cloth_shapekey_quene = new QI.Deformation("ENTIRE_MESH"  ,"Cloth", cloth_shapekey_val, duration); 
 
                //console.log( "cloth_step_real = "+ cloth_step_real);
                
                //console.log("cloth_shapekey_val = "+cloth_shapekey_val);
                
                
               // mesh2.queueSingleEvent(cloth_shapekey_quene);
                //////////////////////////
                // animate cloth -- end
                //////////////////////////
                
                
            });
        });

        //Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });


    }else{
        alert("WebGL not supported in this browser.");
    }

    function updateslidervertexdeformation(slideamount,slideamount2,slideamount3,slideamount4,slideamount5,slideamount6,slideamount7){
        
      
    
        
        var shapekeyslide = new QI.VertexDeformation("ENTIRE_MESH","BASIS",["bodyShape_skin_Shape.Height","bodyShape_skin_Shape.Weight","bodyShape_skin_Shape.Waist","bodyShape_skin_Shape.Upperchest","bodyShape_skin_Shape.Shoulder","bodyShape_skin_Shape.Hip","bodyShape_skin_Shape.Breast"],[slideamount,slideamount2,slideamount3,slideamount4,slideamount5,slideamount6,slideamount7],1);
        //CLO3Dmesh12.queueSingleEvent(test1);
        mdbody.queueSingleEvent(shapekeyslide);
          
        }
    
    function clothsizeupdate() {
            
             for (i = 47; i<=127; i=i+20){
                 for (j = 138; j<=206; j=j+17){
                     if (scene.getMeshByName("cloth1weight" + i + "height" + j )){
                         
                 scene.getMeshByName("cloth1weight" + i + "height" + j ).dispose();
                 console.log("cloth1weight" + i + "height" + j );
                     }
              
                 }
             }
            
            
            var cloth_mesh = new TOB_mdcloth.MeshFactory(scene); // materialsRootDir optional
            var weightsilder = document.getElementById("slide2").value*100+47;
            var heightsilder = (document.getElementById("slide1").value*-1+1)*17/0.25+138;
            
            var mesh1 = cloth_mesh.instance("cloth1weight" + weightsilder + "height" + heightsilder ); // cloneSkeleton optional
            mesh1.material= bumpMaterial;     
        
            
	       
	    
            mesh1.animations.push(anim);
	        scene.beginAnimation(mesh1, 60, 0, true, 1);
            
            
            
    }
   

</script>
</body>
</html>

